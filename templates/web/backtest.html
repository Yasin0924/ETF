<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>策略回测 - ETF 组合分析系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body>
    <nav class="sidebar">
        <a href="/" class="logo" style="display:block;text-decoration:none;color:inherit;">ETF 智能投研系统</a>
        <a href="/" class="nav-item">组合总览</a>
        <a href="/backtest" class="nav-item active">策略回测</a>
        <a href="/screening" class="nav-item">基金筛选</a>
        <a href="/strategy" class="nav-item">策略参数</a>
        <a href="/dca" class="nav-item">定投模拟</a>
        <a href="/data" class="nav-item">数据查询</a>
    </nav>
    <main class="content">
        <header class="topbar">
            <h1>回测引擎</h1>
        </header>
        <div id="op-status" class="op-status" role="status" aria-live="polite"></div>

        <section class="card">
            <h3>回测参数配置</h3>
            <form id="bt-form" class="form-grid">
                <div class="form-group">
                    <label for="initial_capital">初始资金 (元)</label>
                    <input type="number" id="initial_capital" value="100000" min="1000" step="1000">
                </div>
                <div class="form-group">
                    <label for="start_date">开始日期</label>
                    <input type="date" id="start_date" value="2020-01-01">
                </div>
                <div class="form-group">
                    <label for="end_date">结束日期</label>
                    <input type="date" id="end_date" value="2025-01-01">
                </div>
                <div class="form-group">
                    <label for="benchmark">基准指数</label>
                    <select id="benchmark">
                        <option value="000300" selected>沪深300</option>
                        <option value="000905">中证500</option>
                        <option value="000016">上证50</option>
                    </select>
                </div>
                <div class="form-group form-action">
                    <button type="submit" id="run-btn" class="btn-primary">执行回测</button>
                </div>
            </form>
        </section>

        <section class="card" style="margin-top: 16px;">
            <h3>样本外验证</h3>
            <p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:12px;">将历史数据按比例划分为训练集和验证集，评估策略的泛化能力。</p>
            <form id="val-form" class="form-grid">
                <div class="form-group">
                    <label for="val_train_ratio">训练集比例 (0-1)</label>
                    <input type="number" id="val_train_ratio" value="0.7" min="0.1" max="0.9" step="0.1">
                </div>
                <div class="form-group">
                    <label for="val_start_date">开始日期</label>
                    <input type="date" id="val_start_date" value="2020-01-01">
                </div>
                <div class="form-group">
                    <label for="val_end_date">结束日期</label>
                    <input type="date" id="val_end_date" value="2025-01-01">
                </div>
                <div class="form-group">
                    <label for="val_initial_capital">初始资金</label>
                    <input type="number" id="val_initial_capital" value="100000" step="1000">
                </div>
                <div class="form-group form-action">
                    <button type="submit" id="val-btn" class="btn-secondary">执行验证</button>
                </div>
            </form>
            <div id="val-result" style="margin-top:16px;"></div>
        </section>

        <section class="card" style="margin-top: 16px;">
            <h3>参数敏感性分析</h3>
            <p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:12px;">分析单一参数变化对策略收益的影响，寻找参数平原。</p>
            <form id="sens-form" class="form-grid">
                <div class="form-group">
                    <label for="sens_param">参数名</label>
                    <select id="sens_param">
                <option value="ma_period">均线周期</option>
                <option value="daily_drop_trigger">跌幅阈值</option>
                <option value="pe_percentile_threshold">估值分位阈值</option>
                <option value="deviation_single">单标偏离阈值</option>
                <option value="pause_add_threshold">暂停加仓阈值</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sens_values">参数值 (逗号分隔)</label>
                    <input type="text" id="sens_values" value="10,20,30,60,120">
                </div>
                <div class="form-group">
                     <label for="sens_start_date">开始日期</label>
                     <input type="date" id="sens_start_date" value="2020-01-01">
                </div>
                <div class="form-group">
                     <label for="sens_end_date">结束日期</label>
                     <input type="date" id="sens_end_date" value="2025-01-01">
                </div>
                <div class="form-group form-action">
                    <button type="submit" id="sens-btn" class="btn-secondary">执行分析</button>
                </div>
            </form>
            <div id="sens-chart" style="width:100%;height:300px;margin-top:16px;display:none;"></div>
        </section>


        <section id="results-section" style="display:none;">
            <div class="kpi-row" id="bt-kpi"></div>
            <div style="margin:8px 0 12px 0;display:flex;gap:8px;flex-wrap:wrap;">
                <button id="export-backtest" type="button" class="btn-secondary">导出回测结果</button>
                <span id="export-msg" class="empty-tip" style="padding:0;text-align:left;"></span>
            </div>

            <div class="card">
                <h3>净值曲线</h3>
                <div id="bt-equity" style="width:100%;height:380px;"></div>
            </div>

            <div class="card">
                <h3>回撤曲线</h3>
                <div id="bt-drawdown" style="width:100%;height:260px;"></div>
            </div>

            <div class="card">
                <h3>交易日志</h3>
                <div id="bt-trades" style="max-height:400px;overflow-y:auto;"></div>
            </div>
        </section>

        <div id="loading" style="display:none;text-align:center;padding:60px;">
            <div style="font-size:1.2em;color:#53a8ff;">回测执行中...</div>
        </div>
    </main>

    <script>
    (function(){
        var form = document.getElementById('bt-form');
        var resultsSection = document.getElementById('results-section');
        var loading = document.getElementById('loading');
        var opStatus = document.getElementById('op-status');
        var latestBacktest = null;

        var tradeTypeMap = {
            'buy': '买入',
            'sell': '卖出',
            'add': '加仓',
            'take_profit': '止盈',
            'stop_loss': '止损',
            'rebalance': '调仓'
        };
        function cnType(t) { return tradeTypeMap[t] || t; }
        function cnReason(r) {
            var s = String(r || '');
            if (!s) return '-';
            if (s.indexOf('portfolio drawdown') >= 0) return '组合回撤触发风控减仓';
            if (s.indexOf('value/drop trigger hit') >= 0) return '估值/跌幅触发买入或加仓';
            if (s.indexOf('daily drop trigger hit') >= 0) return '单日下跌触发买入或加仓';
            if (s.indexOf('Weight deviation') >= 0) return '仓位偏离触发调仓';
            if (s.indexOf('Return ') >= 0) return '收益率触发止盈';
            if (s.indexOf('Loss ') >= 0) return '亏损触发止损';
            return s;
        }

        function enableDatePickerQuickOpen() {
            document.querySelectorAll('input[type="date"]').forEach(function(el) {
                var open = function() {
                    if (typeof el.showPicker === 'function') {
                        try { el.showPicker(); } catch (e) {}
                    }
                };
                el.addEventListener('focus', open);
                el.addEventListener('click', open);
                el.addEventListener('pointerdown', open);
            });
        }

        function fmt(n) { return typeof n === 'number' ? n.toFixed(2) : n; }
        function pct(n) { return typeof n === 'number' ? (n*100).toFixed(2)+'%' : n; }
        function setStatus(type, msg) {
            opStatus.className = 'op-status show ' + type;
            opStatus.textContent = msg;
        }
        function cnMessage(msg) {
            var m = String(msg || '');
            if (m === 'start_date must be <= end_date') return '开始日期不能晚于结束日期';
            if (m === 'values must be non-empty list') return '参数值列表不能为空';
            return m || '未知错误';
        }

        form.addEventListener('submit', function(e){
            e.preventDefault();
            resultsSection.style.display = 'none';
            loading.style.display = 'block';
            setStatus('loading', '正在执行回测，请稍候...');

            var body = {
                initial_capital: parseFloat(document.getElementById('initial_capital').value),
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
                benchmark: document.getElementById('benchmark').value
            };

            fetch('/api/backtest/run', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            })
            .then(function(r){return r.json();})
            .then(function(resp){
                loading.style.display = 'none';
                if (resp.status_code !== 0) {
                    setStatus('error', '执行失败：' + cnMessage(resp.message));
                    return;
                }
                latestBacktest = resp.data;
                resultsSection.style.display = 'block';
                renderResults(resp.data);
                var sourceMap = { live_akshare: '实时数据', local_csv: '本地历史数据', synthetic: '模拟数据' };
                var sourceText = sourceMap[(resp.data.config || {}).data_source] || '未知';
                setStatus('success', '回测执行完成（来源：' + sourceText + '）。');
            })
            .catch(function(err){
                loading.style.display = 'none';
                setStatus('error', '请求失败：' + cnMessage(err.message));
            });
        });

        function renderResults(data) {
            var m = data.metrics;
            var kpis = [
                {label:'累计收益率', value:pct(m.total_return), cls:m.total_return>0?'positive':'negative'},
                {label:'年化收益率', value:pct(m.annual_return), cls:m.annual_return>0?'positive':'negative'},
                {label:'最大回撤', value:pct(m.max_drawdown), cls:'negative'},
                {label:'夏普比率', value:m.sharpe_ratio.toFixed(2), cls:''},
                {label:'波动率', value:pct(m.volatility), cls:''},
                {label:'胜率', value:pct(m.win_rate), cls:''},
                {label:'总交易次数', value:m.total_trades, cls:''}
            ];
            var html = '';
            kpis.forEach(function(k){
                html += '<div class="kpi-card"><div class="kpi-label">'+k.label+'</div><div class="kpi-value '+k.cls+'">'+k.value+'</div></div>';
            });
            document.getElementById('bt-kpi').innerHTML = html;

            var eqEl = document.getElementById('bt-equity');
            var ddEl = document.getElementById('bt-drawdown');
            if (!data.equity_curve || data.equity_curve.length === 0) {
                eqEl.innerHTML = '<p class="empty-tip">暂无净值曲线数据</p>';
                ddEl.innerHTML = '<p class="empty-tip">暂无回撤数据</p>';
            } else {
                var dates = data.equity_curve.map(function(e){return e.date;});
                var values = data.equity_curve.map(function(e){return e.total_value;});
                var eqChart = echarts.init(eqEl);
                eqChart.setOption({
                    tooltip:{trigger:'axis'},
                    grid:{left:60,right:20,bottom:40,top:20},
                    xAxis:{type:'category',data:dates,axisLabel:{rotate:30}},
                    yAxis:{type:'value'},
                    dataZoom:[{type:'inside'},{type:'slider',height:18,bottom:0}],
                    series:[{type:'line',data:values,smooth:true,itemStyle:{color:'#2196F3'},areaStyle:{color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(33,150,243,0.12)'},{offset:1,color:'rgba(33,150,243,0)'}])}}]
                });
                window.addEventListener('resize',function(){eqChart.resize();});
            }

            var trades = data.trade_log || [];
            if (trades.length === 0) {
                document.getElementById('bt-trades').innerHTML = '<p class="empty-tip">暂无交易记录</p>';
            } else {
                var th = '<table class="data-table"><thead><tr><th>日期</th><th>代码</th><th>类型</th><th>单位净值</th><th>金额/份额</th><th>费用</th><th>原因</th></tr></thead><tbody>';
                trades.forEach(function(t){
                    var cls = t.type==='buy'||t.type==='add'?'positive':'negative';
                    th += '<tr><td>'+t.date+'</td><td>'+t.code+'</td><td class="'+cls+'">'+cnType(t.type)+'</td><td>'+(t.nav||'-')+'</td><td>'+(t.amount?fmt(t.amount):t.shares||'-')+'</td><td>'+(t.fee?fmt(t.fee):'-')+'</td><td>'+cnReason(t.reason)+'</td></tr>';
                });
                th += '</tbody></table>';
                document.getElementById('bt-trades').innerHTML = th;
            }
        }

        // Validation Logic
        document.getElementById('val-form').addEventListener('submit', function(e) {
            e.preventDefault();
            var btn = document.getElementById('val-btn');
            var originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = '验证中...';
            
            var body = {
                train_ratio: parseFloat(document.getElementById('val_train_ratio').value),
                start_date: document.getElementById('val_start_date').value,
                end_date: document.getElementById('val_end_date').value,
                initial_capital: parseFloat(document.getElementById('val_initial_capital').value)
            };

            fetch('/api/backtest/validate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            })
            .then(function(r){return r.json();})
            .then(function(resp){
                btn.disabled = false;
                btn.innerText = originalText;
                if (resp.status_code !== 0) {
                    setStatus('error', '样本外验证失败：' + cnMessage(resp.message));
                    return;
                }
                renderValidation(resp.data);
                setStatus('success', '样本外验证完成。');
            })
            .catch(function(err){
                 btn.disabled = false;
                 btn.innerText = originalText;
                 setStatus('error', '请求失败：' + cnMessage(err.message));
            });
        });

        function renderValidation(data) {
             var html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">';
             ['train_metrics', 'validation_metrics'].forEach(function(k){
                 var m = data[k];
                 var title = k === 'train_metrics' ? '训练集 (样本内)' : '验证集 (样本外)';
                 html += '<div class="card" style="border:1px solid var(--line);"><h4>'+title+'</h4>';
                 html += '<div class="kpi-row" style="grid-template-columns:1fr 1fr;margin-top:10px;">';
                 html += '<div class="kpi-card"><div class="kpi-label">累计收益</div><div class="kpi-value '+(m.total_return>0?'positive':'negative')+'">'+pct(m.total_return)+'</div></div>';
                 html += '<div class="kpi-card"><div class="kpi-label">最大回撤</div><div class="kpi-value negative">'+pct(m.max_drawdown)+'</div></div>';
                 html += '<div class="kpi-card"><div class="kpi-label">夏普比率</div><div class="kpi-value">'+fmt(m.sharpe_ratio)+'</div></div>';
                 html += '<div class="kpi-card"><div class="kpi-label">胜率</div><div class="kpi-value">'+pct(m.win_rate)+'</div></div>';
                 html += '</div></div>';
             });
             html += '</div>';
             document.getElementById('val-result').innerHTML = html;
        }

        // Sensitivity Logic
        document.getElementById('sens-form').addEventListener('submit', function(e) {
             e.preventDefault();
             var btn = document.getElementById('sens-btn');
             var originalText = btn.innerText;
             btn.disabled = true;
             btn.innerText = '分析中...';
             var chartEl = document.getElementById('sens-chart');
             chartEl.style.display = 'block';

             var vals = document.getElementById('sens_values').value.split(',').map(function(s){return parseFloat(s.trim());}).filter(function(n){return !isNaN(n);});
             
             var body = {
                 param: document.getElementById('sens_param').value,
                 values: vals,
                 start_date: document.getElementById('sens_start_date').value,
                 end_date: document.getElementById('sens_end_date').value,
                 initial_capital: 100000 
             };

             fetch('/api/backtest/sensitivity', {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify(body)
             })
             .then(function(r){return r.json();})
             .then(function(resp){
                 btn.disabled = false;
                 btn.innerText = originalText;
                 if (resp.status_code !== 0) {
                     setStatus('error', '参数敏感性分析失败：' + cnMessage(resp.message));
                     return;
                 }
                 renderSensitivity(resp.data);
                 setStatus('success', '参数敏感性分析完成。');
              })
              .catch(function(err){
                  btn.disabled = false;
                  btn.innerText = originalText;
                  setStatus('error', '请求失败：' + cnMessage(err.message));
              });
        });

        function renderSensitivity(data) {
            var chart = echarts.init(document.getElementById('sens-chart'));
            var x = data.points.map(function(p){return p.value;});
            var y = data.points.map(function(p){
                if (typeof p.annual_return === 'number') return p.annual_return * 100;
                if (p.metrics && typeof p.metrics.total_return === 'number') return p.metrics.total_return * 100;
                return 0;
            });
            
            chart.setOption({
                title: { text: '参数敏感性：' + data.param, left: 'center', textStyle: { color: '#e8f0ff' } },
                tooltip: { trigger: 'axis', formatter: '{b}: {c}%' },
                xAxis: { type: 'category', data: x, name: '参数值', axisLabel: { color: '#95a8d8' } },
                yAxis: { type: 'value', name: '年化收益率(%)', axisLabel: { color: '#95a8d8' }, splitLine: { lineStyle: { color: 'rgba(120,168,255,0.16)' } } },
                series: [{ type: 'bar', data: y, itemStyle: { color: '#53a8ff' } }]
            });
            window.addEventListener('resize',function(){chart.resize();});
        }

        document.getElementById('export-backtest').addEventListener('click', function(){
            if (!latestBacktest) {
                document.getElementById('export-msg').textContent = '请先执行回测后再导出。';
                setStatus('error', '尚无可导出的回测结果。');
                return;
            }
            var payload = {
                metrics: latestBacktest.metrics || {},
                trade_log: latestBacktest.trade_log || [],
                exported_at: new Date().toLocaleString('zh-CN')
            };
            var blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = '回测结果.json';
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('export-msg').textContent = '已导出回测结果。';
            setStatus('success', '回测结果导出成功。');
        });

        enableDatePickerQuickOpen();
    })();
    </script>
</body>
</html>
