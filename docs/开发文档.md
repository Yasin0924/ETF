# ETF 智能投研系统开发文档（当前阶段）

## 1. 项目定位

本项目是一个面向 ETF 投资分析的全流程系统，覆盖数据获取、策略回测、基金筛选、定投模拟与前端可视化。

当前阶段重点：

- Web 前端全中文展示（用户可见文本）
- 真实数据优先（本地 CSV + 实时抓取）
- 无结果场景的人性化引导（推荐参数 + 一键重试）
- 关键页面统一三态反馈（加载中/成功/失败）

## 2. 总体架构

核心代码位于 `src/etf_analyzer/`：

- `core/`：统一响应模型、日志、配置、缓存
- `data/`：数据抓取（AKShare）、清洗、增量更新、存储
- `strategy/`：策略规则、信号生成（买入/加仓/止盈/止损/调仓）
- `simulation/`：定投模拟、持仓管理、费用计算
- `backtest/`：回测引擎与指标计算
- `web/`：Flask 路由与页面接口

前端模板位于 `templates/web/`，样式在 `static/css/dashboard.css`。

## 3. 数据流（真实数据优先）

### 3.1 主要链路

1. 前端发起请求（如 `/api/data/etf/<code>`）
2. Web 层尝试读取本地历史数据（`data/etf/*.csv`）
3. 本地不足时触发 `DataUpdater` 增量/全量拉取
4. 拉取成功后写入 `EtfDataStore`，再返回给前端

### 3.2 关键实现

- 抓取器：`src/etf_analyzer/data/fetcher.py`
  - 主备数据源支持
  - 重试机制
  - 历史数据列名标准化
- 更新器：`src/etf_analyzer/data/updater.py`
- 存储：`src/etf_analyzer/data/store.py`
- Web 真实数据组装：`src/etf_analyzer/web/app.py`

### 3.3 配置文件

- `config/settings.yaml`：系统数据目录等
- `config/data_sources.yaml`：数据源优先级、更新策略、ETF 分类
- `config/strategy_params.yaml`：策略参数

## 4. Web API 概览（开发关注）

主要定义在 `src/etf_analyzer/web/app.py`：

- `GET /api/health` 健康检查
- `GET /api/system/status` 系统状态（数据源、校验、缓存）
- `POST /api/system/refresh` 刷新请求
- `POST /api/backtest/run` 回测执行
- `POST /api/backtest/validate` 样本外验证
- `POST /api/backtest/sensitivity` 参数敏感性分析
- `POST /api/dca/run` 定投模拟
- `GET /api/data/etf/<code>` ETF 数据查询
- `POST /api/selection/screen` 基金筛选
- `GET/PUT /api/strategy/params` 策略参数读取/更新
- `POST /api/strategy/signals` 策略信号预览

## 5. 前端已落地能力（当前阶段）

- 首页：回测概览、风控状态、系统状态、最近交易日志
- 回测页：回测、样本外验证、参数敏感性分析、导出
- 筛选页：真实筛选、排序、导出、候选池联动、一键应用推荐参数
- 策略页：参数在线编辑、参数校验提示、候选池一键应用、信号预览
- 定投页：真实 NAV 驱动模拟、分红方式入口、日期中文化显示
- 数据页：真实数据查询、缓存/来源状态展示、刷新

## 6. 开发规范与建议

### 6.1 接口返回规范

统一使用 `ApiResponse`：

- `status_code`：0 成功 / 1 警告 / 2 错误
- `data`：业务数据
- `message`：可读提示

### 6.2 测试策略

- Web 接口改动：优先更新 `tests/test_web/test_app.py`
- 策略逻辑改动：同步更新 `tests/test_strategy/*`
- 数据层改动：同步更新 `tests/test_data/*`

推荐命令：

```bash
pytest tests/test_web/test_app.py -q
pytest -q
```

### 6.3 常见坑位

- 外网可达不代表数据源稳定，需做好主备与重试
- 数据源函数签名可能不同，必须做源适配
- 无结果不等于接口错误，优先返回可操作引导
- 用户可见文本务必保持中文一致

## 7. 调试与排障

### 7.1 筛选结果为 0

优先检查筛选阈值是否过严（跟踪误差、ROE、分位阈值），系统会返回推荐参数。

### 7.2 数据抓取失败

先看日志是否为代理/远端断开：

- `ProxyError` / `RemoteDisconnected`

再确认：

- 当前终端代理环境变量
- 数据源配置与重试设置
- 本地 `data/etf/*.csv` 是否已有历史数据可回放

### 7.3 前端显示旧内容

- 强制刷新浏览器缓存（Ctrl+F5）
- 确认后端已重启并加载最新代码

## 8. 后续建议（开发视角）

- 抽离统一中文文案字典，避免页面内重复映射
- 为筛选诊断增加“每个条件过滤掉多少只基金”统计
- 加入页面 E2E 自动化（关键路径：筛选 -> 策略 -> 回测）
